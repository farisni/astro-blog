---
import type { MarkdownHeading } from "astro";

interface Props {
  headings: MarkdownHeading[];
}

const { headings } = Astro.props;

const toc = headings.filter((h) => h.depth >= 2 && h.depth <= 3);

const h2Items = toc.filter((h) => h.depth === 2);
const h3ByH2 = new Map<string, MarkdownHeading[]>();

let currentH2 = "";
for (const heading of toc) {
  if (heading.depth === 2) {
    currentH2 = heading.slug;
    h3ByH2.set(currentH2, []);
  } else if (heading.depth === 3 && currentH2) {
    h3ByH2.get(currentH2)?.push(heading);
  }
}
---

{
  toc.length > 0 && (
    <nav class="toc sticky top-5 h-[calc(100vh-5rem)] overflow-y-auto scrollbar-hide ps-4 border-s border-border/50">
      <h2 class="mb-3 text-sm font-semibold uppercase tracking-wide text-foreground/80">
        目录
      </h2>
      <ul class="space-y-2 text-sm">
        {h2Items.map((h2) => {
          const h3s = h3ByH2.get(h2.slug) || [];
          const hasChildren = h3s.length > 0;
          
          return (
            <li class:list={[{ "has-children": hasChildren }]}>
              <a
                href={`#${h2.slug}`}
                class="block text-foreground/70 hover:text-accent"
                data-toggle={hasChildren ? h2.slug : undefined}
              >
                {h2.text}
              </a>
              {hasChildren && (
                <ul class="toc-children mt-1 space-y-1 ps-4" data-children={h2.slug}>
                  {h3s.map((h3) => (
                    <li>
                      <a
                        href={`#${h3.slug}`}
                        class="block truncate text-foreground/70 hover:text-accent"
                      >
                        {h3.text}
                      </a>
                    </li>
                  ))}
                </ul>
              )}
            </li>
          );
        })}
      </ul>
    </nav>
  )
}

<script>
  document.querySelectorAll(".has-children > a").forEach((link) => {
    link.addEventListener("click", (e) => {
      const target = e.currentTarget as HTMLAnchorElement;
      const parentSlug = target.dataset.toggle;
      if (!parentSlug) return;
      
      const children = document.querySelector(`[data-children="${parentSlug}"]`);
      children?.classList.toggle("hidden");
    });
  });
</script>
